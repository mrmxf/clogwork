# Copyright Â©2017-2025  Mr MXF   info@mrmxf.com
# BSD-3-Clause License           https://opensource.org/license/bsd-3-clause/
# clogwork - collection of reusable actions and tools for Mr MXF project.
#
#   _             _   _      _         _
#  | |__   _  _  (_) | |  __| |  ___  | |_    _  _   __ _   ___
#  | '_ \ | || | | | | | / _` | |___| | ' \  | || | / _` | / _ \
#  |_.__/  \_,_| |_| |_| \__,_|       |_||_|  \_,_| \__, | \___/
#                                                   |___/
#
#  GitHub Workflow to build a hugo website for staging or production
#
# - secrets.DOCKER_PAT - the personal access token for docker hub
# -     vars.DOCKER_NS - the account namespace for docker hub e.g. mrmxf
# - secrets.HOOK_SLACK - the SLACK HOOK to post messages to the team

name: build-hugo
run-name: ðŸ¥·${{ github.actor }} ðŸƒâ€âž¡ï¸ ${{ github.workflow }}.${{ github.job }}(clogwork/.../build-hugo)"
env:
  CLOGWORK_REPO: "mrmxf/clogwork/.github/workflows"
  CLOGWORK_FLOW: "mrmxf/clogwork/.github/workflows/build-hugo"
on:
  workflow_call:
    inputs:
      artifact-name:
        required: true
        type: string
      docker_ns:
        required: true
        type: string
    secrets:
      docker_pat:
        required: true
      get_clog:
        required: true
    outputs:
      message:
        description: "Result of the build for announcing on slack"
        value: ${{ jobs.clog-build.outputs.message }}

jobs:
  build-hugo:
    runs-on: ubuntu-latest
    outputs:
      message: ${{ steps.clog-build.outputs.message }}

    steps:
      - # ---------------------------------------------------------------------
        id: check
        name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - # ---------------------------------------------------------------------
        id: docker
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{  inputs.docker_ns }}
          password: ${{ secrets.docker_pat }}
      - # ---------------------------------------------------------------------
        id: get-clog
        name: get clog
        env:
          GET_CLOG: ${{ secrets.get_clog }}
        run: |
          eval "$GET_CLOG"
          clog Log -I "Reusable workflow: ${{ env.CLOGWORK_FLOW}}"
      - # ---------------------------------------------------------------------
        id: clog-setup
        name: setup tools
        run: |
          clog install golang
          clog install hugo
          clog install ko
      - # ---------------------------------------------------------------------
        id: clog-build
        name: hugo container with clog
        env:
          DOCKER_NS: ${{ inputs.docker_ns }}
        run: |
          rm -f /tmp/clog-notify >/dev/null 2>&1  # delete any notify file
          clog build
          if [ -f /tmp/clog-notify ]; then
            echo "message=\"$(cat /tmp/clog-notify)\"" >> $GITHUB_OUTPUT
          else
            mImage="$DOCKER_NS/${{ github.event.repository.name }}:"
            printf "message=\"deployed image: $mImage, github action: $CLOGWORK_FLOW\""
          fi
      - # ---------------------------------------------------------------------
        name: kodata/ â†’  artifact(${{ inputs.artifact-name }})
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          retention-days: 2
          path: kodata
      - # ---------------------------------------------------------------------
        id: notify
        name: notify-team
        env:
          CLOG_BUILD_MSG: ${{ steps.clog-build.outputs.message }}
        run: clog Log -I "$CLOG_BUILD_MSG"
