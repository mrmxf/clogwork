# Copyright ©2017-2025  Mr MXF   info@mrmxf.com
# BSD-3-Clause License           https://opensource.org/license/bsd-3-clause/
# clogwork - collection of reusable actions and tools for Mr MXF project.
#   _             _   _      _                      _                      
#  | |__   _  _  (_) | |  __| |  ___   __ _   ___  | |  __ _   _ _    __ _ 
#  | '_ \ | || | | | | | / _` | |___| / _` | / _ \ | | / _` | | ' \  / _` |
#  |_.__/  \_,_| |_| |_| \__,_|       \__, | \___/ |_| \__,_| |_||_| \__, |
#                                     |___/                          |___/ 
#
#  GitHub Workflow to build golang executable artifacts
#
# - input.artifact-name - the artifact name for the build
# - secrets.HOOK_SLACK  - the SLACK HOOK to post messages to the team

name: build-hugo
run-name: 👷🏻‍♀️${{ github.actor }} 🏗️build-hugo(--name-to-be-inserted--) 🚀
on:
  workflow_call:
    inputs:
      artifact-name:
        required: false
        type: string
      docker_ns:
        required: true
        type: string
    secrets:
      docker_pat:
        required: true
      get_clog:
        required: true
    outputs:
      message:
        description: "Result of the build for announcing on slack"
        value: ${{ jobs.build-hugo.outputs.message }}

jobs:
  build-hugo:
    runs-on: ubuntu-latest
    outputs:
      message: ${{ steps.clog.outputs.message }}

    steps:
      - # ---------------------------------------------------------------------
        id: check
        name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - # ---------------------------------------------------------------------
        id: docker
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_NS }}
          password: ${{ secrets.DOCKER_PAT }}
      - # ---------------------------------------------------------------------
        id: clog
        name: Build Hugo & Container with clog
        env:
          GET_CLOG: ${{ secrets.GET_CLOG }}
        run: |
          eval "$GET_CLOG"
          clog install golang
          clog install hugo
          clog install ko
          clog build
          echo "message=\"Hugo Build success\"" >> $GITHUB_OUTPUT
      - # ---------------------------------------------------------------------
        name: Hugo artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-without-markdown
          retention-days: 3
          path: |
            ko_data
            !dist/**/*.md